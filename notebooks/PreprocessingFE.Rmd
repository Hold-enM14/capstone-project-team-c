---
title: "Preprocessing and Feature Engineering"
date: "2025-11-20"
output: html_document
---


Load libraries
```{r}
library(dplyr)
library(knitr)
library(tidyr)
library(ggplot2)
```

```{r}
#setwd()
```


Importing the data
```{r}
final_data = read.csv("merged_marathon_data.csv")
```

```{r}
# view merged data
str(final_data)
summary(final_data)
```

```{r}
# missing values for visibility, co, pm10, pm2.5
missing_summary <- final_data %>%
  summarise(across(everything(), ~sum(is.na(.))))

knitr::kable(missing_summary, caption = "Missing Values per Variable")
```

```{r}
# create supershoes control
final_data <- final_data %>%
  mutate(
    supershoe_era = ifelse(year >= 2018, 1, 0)
  )
```


```{r}
# indicate and define year of covid
final_data <- final_data %>%
  mutate(
    covid_era = ifelse(year == 2020, 1, 0)
  )
```

```{r}
# replacing the numeric variables with missing data with mean (could do median if we keep this); most likely dropping though
numeric_vars <- final_data %>%
  select(where(is.numeric)) %>%
  names()

final_data <- final_data %>%
  mutate(across(all_of(numeric_vars), ~ifelse(is.na(.), mean(., na.rm = TRUE), .)))
```

```{r}
# create custom cutoff times for performance groups
final_data <- final_data %>%
  mutate(
    finish_hours = avg_chip_seconds / 3600, # think we are having all time in seconds, need fixing
    subgroup2 = case_when(
      finish_hours < 3 ~ "elite",
      finish_hours < 3.75 ~ "competitive",
      finish_hours < 4.75 ~ "average",
      finish_hours < 5.75 ~ "recreational",
      TRUE ~ "slow"
    )
  )
```

```{r}
# scale numerics
scale_vars <- final_data %>%
  select(
    high_temp, low_temp, avg_temp, precipitation, dew_point,
    wind_speed, visibility, sea_level_pressure, aqi, pm10, pm25, no2, ozone, co
  ) %>%
  names()

# apply scaling
final_data_scaled <- final_data %>%
  mutate(across(all_of(scale_vars), scale))
```

```{r}
# create interaction terms
final_data_scaled <- final_data_scaled %>%
  mutate(
    temp_dew_interaction       = avg_temp * dew_point,
    temp_aqi_interaction       = avg_temp * aqi, # can remove
    temp_precip_interaction    = avg_temp * precipitation,
    temp_wind_interaction      = avg_temp * wind_speed,
    pm25_temp_interaction      = pm25 * avg_temp,
    dew_wind_interaction       = dew_point * wind_speed,
    pressure_temp_interaction  = sea_level_pressure * avg_temp,
    avg_temp_gender_interaction = avg_temp * as.numeric(gender == "male")
  )

```


```{r}
# split data into train and test
set.seed(123)

train_index <- sample(1:nrow(final_data_scaled), size = 0.8*nrow(final_data_scaled))

train_data <- final_data_scaled[train_index, ]
test_data  <- final_data_scaled[-train_index, ]
```

```{r}
# environmental predictors
env_vars <- c(
  "high_temp", "low_temp", "avg_temp",
  "precipitation", "dew_point", "wind_speed",
  "sea_level_pressure", "pm25", "no2", "ozone"
)

env_data <- final_data_scaled %>%
  select(all_of(env_vars))

pca_env <- prcomp(env_data, center = TRUE, scale. = TRUE)
summary(pca_env)
```

```{r}
library(knitr)

pca_var <- data.frame(
  PC = paste0("PC", 1:length(pca_env$sdev)),
  Eigenvalue = pca_env$sdev^2,
  Proportion_Variance = (pca_env$sdev^2) / sum(pca_env$sdev^2),
  Cumulative_Variance = cumsum((pca_env$sdev^2) / sum(pca_env$sdev^2))
)

kable(
  pca_var,
  digits = 3, # can adjust after
  caption = "Table Y: Variance Explained by Principal Components for Environmental Variables"
)
```

```{r}
library(ggplot2)

ggplot(pca_var, aes(x = as.numeric(gsub("PC", "", PC)), y = Proportion_Variance)) +
  geom_point() +
  geom_line() +
  labs(
    title = "Figure Y: Scree Plot for Environmental PCA",
    x = "Principal Component",
    y = "Proportion of Variance Explained"
  ) +
  theme_minimal()
```

```{r}
pca_scores <- as.data.frame(pca_env$x[, 1:3])
colnames(pca_scores) <- c("PC1_env", "PC2_env", "PC3_env")

final_data_pca <- final_data_scaled %>%
  bind_cols(pca_scores)
```

```{r}
final_data_pca <- final_data_pca %>%
  mutate(
    marathon = factor(marathon),
    gender = factor(gender),
    subgroup2 = factor(subgroup2)
  )
```

```{r}
set.seed(123)

train_index <- sample(1:nrow(final_data_pca), size = 0.8 * nrow(final_data_pca))

train_data <- final_data_pca[train_index, ]
test_data  <- final_data_pca[-train_index, ]
```

```{r}
lm_full <- lm(
  avg_chip_seconds ~ marathon + gender + subgroup2 +
    supershoe_era + covid_era +
    high_temp + low_temp + avg_temp +
    precipitation + dew_point + wind_speed +
    sea_level_pressure + pm25 + no2 + ozone +
    temp_dew_interaction + temp_aqi_interaction + 
    temp_precip_interaction + temp_wind_interaction + pm25_temp_interaction + dew_wind_interaction +     pressure_temp_interaction + avg_temp_gender_interaction,
  data = train_data
)

summary(lm_full)
```

```{r}
# Predictions
lm_full_pred <- predict(lm_full, newdata = test_data)

# versus Actual
y_test <- test_data$avg_chip_seconds

# RMSE
lm_full_rmse <- sqrt(mean((lm_full_pred - y_test)^2))

# R squared on test set (correlation)
lm_full_r2 <- cor(lm_full_pred, y_test)^2

lm_full_rmse
lm_full_r2
```

```{r}
lm_pca <- lm(
  avg_chip_seconds ~ marathon + gender + subgroup2 +
    supershoe_era + covid_era +
    PC1_env + PC2_env + PC3_env,
  data = train_data
)

summary(lm_pca)
```

```{r}
lm_pca_pred <- predict(lm_pca, newdata = test_data)

lm_pca_rmse <- sqrt(mean((lm_pca_pred - y_test)^2))
lm_pca_r2   <- cor(lm_pca_pred, y_test)^2

lm_pca_rmse
lm_pca_r2
```

```{r}
model_compare <- data.frame(
  Model = c("Full Linear", "PCA Linear (PC1â€“PC3)"),
  RMSE  = c(lm_full_rmse, lm_pca_rmse),
  R2    = c(lm_full_r2,   lm_pca_r2)
)

kable(model_compare, digits = 3,
      caption = "Table Z: Model Performance Comparison on Test Set")
```


```{r}
# create a random forest
library(randomForest)

set.seed(123)

rf_model <- randomForest(
  avg_chip_seconds ~ marathon + gender + subgroup2 +
    supershoe_era + covid_era +
    high_temp + low_temp + avg_temp +
    precipitation + dew_point + wind_speed +
    sea_level_pressure +
    pm25 + no2 + ozone +  
    temp_dew_interaction + temp_aqi_interaction + 
    temp_precip_interaction + temp_wind_interaction + pm25_temp_interaction + dew_wind_interaction +     pressure_temp_interaction + avg_temp_gender_interaction,
  data = train_data,
  ntree = 500,
  mtry = 5,
  importance = TRUE
)

rf_model
```

```{r}
rf_pred <- predict(rf_model, newdata = test_data)

rf_rmse <- sqrt(mean((rf_pred - y_test)^2))
rf_r2   <- cor(rf_pred, y_test)^2

rf_rmse
rf_r2
```







